name: CD Docker Deployment

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for CI to build image
      run: sleep 30
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy Docker container
      run: |
        ssh -p 2465 -o StrictHostKeyChecking=no gregory@course.prafdin.ru '
          set -e
          echo "Starting Docker container deployment..."
          
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          
          echo "Pulling latest Docker image..."
          docker pull ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.sha }}
          
          echo "Checking existing containers..."
          docker ps -a
          
          echo "Stopping and removing existing container..."
          docker rm -f catty-reminders 2>/dev/null || echo "No container to remove"
          
          echo "Starting new container..."
          docker run -d \
            --name catty-reminders \
            --restart unless-stopped \
            -p 8181:8181 \
            ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ github.sha }}
          
          echo "Waiting for container to start..."
          sleep 10
          
          echo "=== DIAGNOSTICS ==="
          echo "1. Docker containers:"
          docker ps -a
          
          echo "2. Container logs:"
          docker logs catty-reminders
          
          echo "3. Port listening check:"
          if ss -tulpn | grep -q 8181; then
            echo "Port 8181 is listening"
          else
            echo "Port 8181 is NOT listening"
          fi
          
          echo "4. Local health check:"
          if curl -f http://localhost:8181 > /dev/null 2>&1; then
            echo "Local health check PASSED"
          else
            echo "Local health check FAILED"
          fi
          
          echo "Deployment completed successfully!"
          echo "App is available at: http://app.petrov.course.prafdin.ru"
        '
